<?php
/**
 * Plugin Name: Anti Staticsong Enhanced Plus
 * Description: Protege contra URLs maliciosas em arquivos e no banco de dados, com atualizações dinâmicas de lista de URLs e interface administrativa.
 * Version: 2.0
 * Author: Daniel Oliveira da Paixão
 */

// Carregar a lista de URLs proibidas do banco de dados ou definir lista padrão
function load_prohibited_urls() {
    return get_option('staticsong_prohibited_urls', [
        'https://api.staticsong.com/store/f.php',
        'https://example.com/malicious.php',
        'https://dangerous.com/script.js',
    ]);
}

// Inicialização do plugin e hooks
function init_staticsong_protection() {
    add_action('admin_menu', 'staticsong_admin_menu');
    add_action('init', 'block_staticsong_check_database');
    add_action('wp_loaded', function() {
        block_staticsong_check_files(ABSPATH); // Verifica toda a instalação do WordPress
    });
}
add_action('plugins_loaded', 'init_staticsong_protection');

// Verificar e remover menções no banco de dados
function block_staticsong_check_database() {
    global $wpdb;
    $prohibited_urls = load_prohibited_urls();

    foreach ($prohibited_urls as $url) {
        $wpdb->query(
            $wpdb->prepare(
                "UPDATE {$wpdb->prefix}posts SET post_content = REPLACE(post_content, %s, '') WHERE post_content LIKE %s",
                $url,
                '%' . $wpdb->esc_like($url) . '%'
            )
        );
    }
}

// Verificar e remover menções em arquivos
function block_staticsong_check_files($directory) {
    $prohibited_urls = load_prohibited_urls();
    $files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($directory));

    foreach ($files as $file) {
        if ($file->isFile() && in_array($file->getExtension(), ['php', 'js', 'html', 'htaccess'])) {
            $file_contents = file_get_contents($file->getRealPath());

            foreach ($prohibited_urls as $url) {
                if (strpos($file_contents, $url) !== false) {
                    $file_contents = str_replace($url, '', $file_contents);
                    file_put_contents($file->getRealPath(), $file_contents);
                    log_security_threat("URL maliciosa removida de {$file->getRealPath()}");
                }
            }
        }
    }
}

// Logs de segurança e notificações
function log_security_threat($message) {
    error_log($message); // Log no arquivo de erro do PHP
    // Implemente notificações adicionais conforme necessário
}

// Adicionar menu no painel administrativo
function staticsong_admin_menu() {
    add_menu_page(
        'Anti Staticsong Settings', 
        'Anti Staticsong', 
        'manage_options', 
        'anti-staticsong-settings', 
        'staticsong_settings_page', 
        'dashicons-shield', 
        100 
    );
}

// Renderizar a página de configurações no admin
function staticsong_settings_page() {
    // Checar permissão
    if (!current_user_can('manage_options')) {
        wp_die(__('You do not have sufficient permissions to access this page.'));
    }

    // Verificar envio do formulário
    if (isset($_POST['submit'])) {
        check_admin_referer('update-urls-action', 'update-urls-nonce');

        // Atualizar a lista de URLs
        $new_urls = array_filter(array_map('trim', explode(PHP_EOL, sanitize_textarea_field($_POST['prohibited_urls']))));
        update_option('staticsong_prohibited_urls', $new_urls);

        echo '<div id="message" class="updated fade"><p><strong>URLs atualizadas com sucesso.</strong></p></div>';
    }

    // Carregar as URLs atuais para exibição
    $prohibited_urls = load_prohibited_urls();

    ?>
    <div class="wrap">
        <h1>Anti Staticsong Settings</h1>
        <form method="post" action="">
            <?php
            wp_nonce_field('update-urls-action', 'update-urls-nonce');
            ?>
            <table class="form-table">
                <tr valign="top">
                    <th scope="row">URLs Proibidas:</th>
                    <td>
                        <textarea name="prohibited_urls" rows="10" cols="50" class="large-text code"><?php echo esc_textarea(implode(PHP_EOL, $prohibited_urls)); ?></textarea>
                    </td>
                </tr>
            </table>
            <?php submit_button('Salvar Alterações'); ?>
        </form>
    </div>
    <?php
}
